on: push

jobs:
  main:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@master

    # WALL'O'CACHE!
    - name: cache cargo registry
      uses: actions/cache@v1
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    - name: cache cargo index
      uses: actions/cache@v1
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    # - name: cache ofl target dir
    #   uses: actions/cache@v1
    #   with:
    #     path: ofl/target
    #     key: ${{ runner.os }}-ofl-target-dir-${{ hashFiles('ofl/Cargo.lock') }}
    # - name: cache moxie target dir
    #   uses: actions/cache@v1
    #   with:
    #     path: target
    #     key: ${{ runner.os }}-target-dir-${{ hashFiles('*/Cargo.lock') }}

    # tests
    - run: cargo test-core
    - run: cargo test-dom-lib
    - run: cargo test-ssr-example
      # TODO(https://github.com/anp/moxie/issues/37)
      # run: cargo test-dom-drivertest

    # examples
    - run: cargo build-dom-hacking
    - run: cargo build-dom-todo

    # docs
    - run: cargo docs-all
    - run: cargo docs-ofl

    - run: cargo build-website

    - name: deploy preview
      if: runner.os == 'Linux'
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      run: npx netlify-cli deploy

    - name: promote website to prod, ensure crates published
      if: github.ref == 'refs/heads/master' && runner.os == 'Linux'
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      run: |
        npx netlify-cli deploy --prod
        cargo login ${{ secrets.CARGO_API_TOKEN }}
        cargo ofl published

  clippy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - run: rustup component add clippy
    - run: cargo clippy-core
    - run: cargo clippy-dom
    - run: cargo clippy-ofl

  fmt:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - run: rustup component add rustfmt
    - run: cargo fmt -- --check
    - run: cargo fmt-ofl --check
